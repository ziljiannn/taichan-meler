<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS Taichan Setengah Porsi</title>
    
    <style>
        /* (CSS tetap sama, hanya menambahkan warna untuk input desimal) */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 20px; 
            background-color: #e9ecef; 
            display: flex; 
            justify-content: center; 
        }
        .pos-container { 
            width: 100%; 
            max-width: 950px; 
            background: white; 
            padding: 25px; 
            border-radius: 10px; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); 
        }
        h1 { 
            text-align: center; 
            color: #dc3545; 
            border-bottom: 2px solid #dc3545; 
            padding-bottom: 10px; 
            margin-bottom: 20px; 
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-bottom: 25px; 
        }
        th, td { 
            border: 1px solid #dee2e6; 
            padding: 12px; 
            text-align: left; 
        }
        th { 
            background-color: #dc3545; 
            color: white; 
            font-weight: 600; 
        }
        /* Input Kuantitas diubah menjadi type="text" agar bisa diisi desimal, lalu diproses sebagai number */
        input[type="number"], .qty-input { 
            width: 60px; 
            padding: 8px; 
            border: 1px solid #ced4da; 
            border-radius: 4px; 
            text-align: center; 
        }
        .qty-input {
            width: 70px;
            font-weight: bold;
            color: #007bff; /* Menandakan ini adalah input penting */
        }
        .total-section { 
            padding: 15px; 
            border-top: 3px double #343a40; 
            margin-top: 10px; 
            font-size: 1.2em; 
        }
        .total-row, .payment-row, .change-row { 
            display: flex; 
            justify-content: space-between; 
            padding: 5px 0; 
        }
        .label { 
            font-weight: bold; 
        }
        .value { 
            font-weight: normal; 
            color: #dc3545; 
        }
        .payment-input-group {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }
        .payment-input-group > div {
            display: flex;
            justify-content: space-between;
            width: 350px; 
        }
        .payment-input-group input[type="number"] {
            width: 150px; 
            padding: 10px; 
            font-size: 1.1em; 
            text-align: right; 
        }
        .payment-label {
            font-weight: normal;
        }
        button { 
            padding: 10px 20px; 
            background-color: #28a745; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 1em; 
            margin-top: 15px; 
        }
        button:hover { 
            background-color: #218838; 
        }
        .stock-info { 
            font-size: 0.9em; 
            margin-top: 30px; 
            padding: 15px; 
            border: 1px solid #dc3545; 
            border-radius: 5px;
            background-color: #ffe6e6; 
        }
        .stock-info h3 { 
            margin-top: 0; 
            color: #dc3545; 
            border-bottom: 1px dashed #dc3545;
            padding-bottom: 5px;
        }
        .red-text { color: red; font-weight: bold; }
        .green-text { color: green; font-weight: bold; }

        .revenue-report {
            background-color: #fff3cd; 
            border: 1px solid #ffc107;
            padding: 10px;
            margin-top: 15px;
            border-radius: 5px;
        }
        .revenue-report .rev-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            font-size: 1.1em;
        }
        .revenue-report .rev-row:last-child {
            font-weight: bold;
            border-top: 1px dashed #ffc107;
            margin-top: 5px;
            padding-top: 5px;
        }
        #end-day-button {
            background-color: #dc3545;
            margin-left: 10px;
        }
        #end-day-button:hover {
            background-color: #c82333;
        }
        
        .daily-stock-input {
            width: 100%;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        .daily-stock-input label {
            font-weight: bold;
            color: #343a40;
            margin-right: 5px;
        }
        .daily-stock-input input {
            width: 50px; 
            text-align: right;
        }
    </style>
</head>
<body>

    <div class="pos-container">
        <h1>üå∂Ô∏è Sate Taichan Stok Harian (Half Porsi)</h1>

        <div class="daily-stock-input">
            <span style="font-weight: bold; width: 100%; color: #dc3545;">Input Stok Harian (Unit Porsi):</span>
            <div id="daily-stock-container" style="display: flex; flex-wrap: wrap; gap: 15px;"></div>
            <button onclick="updateStokHarian()" style="background-color: #007bff; margin-top: 0;">Update Stok & Mulai Jual</button>
        </div>
        
        <h2>Daftar Produk</h2>
        <table>
            <thead>
                <tr>
                    <th>Nama Produk</th>
                    <th>Harga Porsi (Rp)</th>
                    <th>Harga Half (Rp)</th>
                    <th>Stok Tersedia (Unit)</th> 
                    <th>Jumlah Beli (Porsi/Desimal)</th>
                    <th>Subtotal (Rp)</th>
                </tr>
            </thead>
            <tbody id="items-list">
                </tbody>
        </table>
        
        <div class="total-section">
            <div class="total-row">
                <span class="label">TOTAL BELANJA:</span>
                <span id="total-belanja" class="value">Rp 0</span>
            </div>
            
            <div class="payment-row">
                <span class="label">METODE BAYAR:</span>
                <div class="payment-input-group">
                    <div>
                        <span class="payment-label">Cash (Tunai):</span>
                        <input type="number" id="uang_cash" min="0" value="0">
                    </div>
                    <div>
                        <span class="payment-label">QRIS / Non-Tunai:</span>
                        <input type="number" id="uang_qris" min="0" value="0">
                    </div>
                </div>
            </div>

            <div class="total-row">
                <span class="label" style="color: #007bff;">TOTAL UANG MASUK:</span>
                <span id="total_uang_masuk" class="value" style="color: #007bff;">Rp 0</span>
            </div>


            <button onclick="hitungTotal()">Finalisasi Transaksi & Update Stok</button>

            <hr style="margin-top: 20px; border-color: #ced4da;">

            <div class="change-row">
                <span class="label">KEMBALIAN:</span>
                <span id="kembalian" class="value">Rp 0</span>
            </div>
        </div>

        <div class="stock-info">
            <h3>Laporan Penjualan & Stok Sisa</h3>
            <div id="report-info"></div>
        </div>

        <div class="revenue-report">
            <h3>Rekapitulasi Pendapatan Harian (Persisten)</h3>
            <div class="rev-row">
                <span>Total Penjualan Tunai:</span>
                <span id="rekap_cash">Rp 0</span>
            </div>
            <div class="rev-row">
                <span>Total Penjualan Non-Tunai (QRIS):</span>
                <span id="rekap_qris">Rp 0</span>
            </div>
            <div class="rev-row">
                <span>TOTAL AKUMULASI PENDAPATAN:</span>
                <span id="rekap_grand_total">Rp 0</span>
            </div>
            <button id="end-day-button" onclick="endDayAndClearData()">Akhiri Hari & Reset Data (Z-Report)</button>
        </div>
    </div>

    <script>
        /* ====================
           JAVASCRIPT: LOGIKA PERMANEN STOK DAN Z-REPORT LENGKAP
           ==================== */

        // ===================================
        // VARIABEL GLOBAL & PERSISTENSI
        // ===================================
        let totalRevenueCash = parseFloat(localStorage.getItem('revenue_cash')) || 0;
        let totalRevenueQris = parseFloat(localStorage.getItem('revenue_qris')) || 0;
        let currentOrderQuantities = {};
        
        // Data Produk Awal (Template) - MENU BARU DENGAN HARGA HALF
        const initialProductsData = [
            // Harga Porsi: Rp 25.000, Harga Half: Rp 17.000
            { id: 1, name: "Campur", price: 25000, priceHalf: 17000, stokAwal: 0, terjual: 0 },
            { id: 2, name: "Kulit", price: 25000, priceHalf: 17000, stokAwal: 0, terjual: 0 },
            { id: 3, name: "Daging", price: 25000, priceHalf: 17000, stokAwal: 0, terjual: 0 },
            // Harga Porsi: Rp 4.000, Harga Half: Rp 3.000
            { id: 4, name: "Lontong", price: 4000, priceHalf: 3000, stokAwal: 0, terjual: 0 }
        ];

        let products = loadProductsFromStorage() || JSON.parse(JSON.stringify(initialProductsData));

        function loadProductsFromStorage() {
            const storedProducts = localStorage.getItem('products_data');
            if (storedProducts) {
                return JSON.parse(storedProducts);
            }
            return null;
        }

        function saveProductsToStorage() {
            localStorage.setItem('products_data', JSON.stringify(products));
        }


        const formatRupiah = (number) => {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(number);
        };

        function saveRevenueData() {
            localStorage.setItem('revenue_cash', totalRevenueCash);
            localStorage.setItem('revenue_qris', totalRevenueQris);
        }
        
        // --- FUNGSI UNTUK INPUT STOK HARIAN (UNIT PORSI) ---

        function loadDailyStockInputs() {
            const container = document.getElementById('daily-stock-container');
            container.innerHTML = '';
            
            products.forEach(product => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <label for="input-stok-${product.id}">${product.name}:</label>
                    <input type="number" id="input-stok-${product.id}" min="0" value="${product.stokAwal}">
                `;
                container.appendChild(div);
            });
        }
        
        function updateStokHarian() {
            let totalStokSet = 0;
            
            products.forEach(product => {
                const inputElement = document.getElementById(`input-stok-${product.id}`);
                const stokBaru = parseFloat(inputElement.value) || 0; // Menggunakan parseFloat untuk stok desimal
                
                if (stokBaru !== product.stokAwal) {
                    product.terjual = 0; 
                }
                
                product.stokAwal = stokBaru;
                totalStokSet += stokBaru;
            });
            
            saveProductsToStorage();
            
            if (totalStokSet >= 0) {
                loadProductsTable(); 
                alert("Stok harian berhasil diperbarui. Siap berjualan!");
            } else {
                alert("Masukkan jumlah stok harian Anda!");
            }
        }
        
        // 2. Fungsi untuk menampilkan produk ke tabel
        function loadProductsTable() {
            const tableBody = document.getElementById('items-list');
            tableBody.innerHTML = ''; 
            let hasStok = false;

            products.forEach(product => {
                const row = tableBody.insertRow();
                
                row.insertCell().textContent = product.name;
                row.insertCell().textContent = formatRupiah(product.price);
                row.insertCell().textContent = formatRupiah(product.priceHalf); // Kolom harga half

                const stokSisa = product.stokAwal - product.terjual;
                if (stokSisa > 0) hasStok = true; 
                
                const stokCell = row.insertCell();
                stokCell.id = `stok-sisa-${product.id}`;
                // Tampilkan stok sisa dengan 1 desimal
                stokCell.textContent = stokSisa.toFixed(1); 
                stokCell.style.fontWeight = 'bold'; 

                // Input Kuantitas diubah type="text" agar bisa desimal
                const quantityCell = row.insertCell();
                const quantityInput = document.createElement('input');
                quantityInput.type = 'text'; 
                quantityInput.className = 'qty-input'; 
                quantityInput.value = '0';
                quantityInput.id = `qty-${product.id}`; 
                quantityInput.addEventListener('input', updateSubtotal); 
                quantityCell.appendChild(quantityInput);

                const subtotalCell = row.insertCell();
                subtotalCell.id = `sub-${product.id}`; 
                subtotalCell.textContent = formatRupiah(0);

                currentOrderQuantities[product.id] = 0;
            });
            
            if (!hasStok && products.every(p => p.stokAwal === 0)) {
                document.getElementById('items-list').innerHTML = '<tr><td colspan="6" style="text-align: center; color: red;"><b>TIDAK ADA STOK HARI INI. SILAKAN INPUT DI ATAS.</b></td></tr>';
            }
            
            document.getElementById('uang_cash').addEventListener('input', updateChange); 
            document.getElementById('uang_qris').addEventListener('input', updateChange); 
            
            updateReport();
            updateRevenueReport();
        }

        // 3. Fungsi updateSubtotal (LOGIKA PERHITUNGAN PORSI DAN HARGA BARU)
        function updateSubtotal() {
            let grandTotal = 0;

            products.forEach(product => {
                const quantityInput = document.getElementById(`qty-${product.id}`);
                const subtotalDisplay = document.getElementById(`sub-${product.id}`);
                
                // Mengganti koma dengan titik dan memastikan input adalah float
                let rawQuantity = quantityInput.value.replace(',', '.');
                const quantity = parseFloat(rawQuantity) || 0; 
                
                const stokTersedia = product.stokAwal - product.terjual;

                // Batasan Stok
                if (quantity > stokTersedia) {
                    alert(`Stok ${product.name} yang tersisa hanya ${stokTersedia.toFixed(1)} unit! Jumlah pembelian direset.`);
                    
                    // Batasi pembelian ke stok tersedia dan bulatkan ke 0.5 terdekat
                    const newQuantity = Math.floor(stokTersedia * 2) / 2; 
                    quantityInput.value = newQuantity.toFixed(1); 
                    
                    currentOrderQuantities[product.id] = newQuantity;

                    // Hitung Subtotal dengan LOGIKA HALF PORSI
                    const subtotal = calculatePrice(product, newQuantity);
                    subtotalDisplay.textContent = formatRupiah(subtotal);
                    grandTotal += subtotal;

                } else {
                    currentOrderQuantities[product.id] = quantity;
                    
                    // Hitung Subtotal dengan LOGIKA HALF PORSI
                    const subtotal = calculatePrice(product, quantity);
                    subtotalDisplay.textContent = formatRupiah(subtotal);
                    grandTotal += subtotal;
                }
            });

            document.getElementById('total-belanja').textContent = formatRupiah(grandTotal);
            updateChange(); 
        }

        // FUNGSI BARU: LOGIKA HARGA SETENGAH PORSI
        function calculatePrice(product, quantity) {
            if (quantity <= 0) return 0;

            const fullPorsi = Math.floor(quantity); // Bagian porsi penuh (misal 2 dari 2.5)
            const halfPorsi = quantity % 1 === 0.5 ? 1 : 0; // Cek apakah ada setengah porsi (misal 0.5 dari 2.5)

            let total = (fullPorsi * product.price);

            if (halfPorsi === 1) {
                total += product.priceHalf;
            }
            return total;
        }


        // 4. Fungsi updateChange (Realtime Split Payment) - Tetap sama
        function updateChange() {
            // ... (Kode updateChange sama) ...
            const totalDisplay = document.getElementById('total-belanja').textContent;
            const totalBelanja = parseFloat(totalDisplay.replace(/[^0-9]/g, '')) || 0; 
            
            const uangCash = parseFloat(document.getElementById('uang_cash').value) || 0;
            const uangQris = parseFloat(document.getElementById('uang_qris').value) || 0;
            
            const totalUangMasuk = uangCash + uangQris;
            const kembalianDisplay = document.getElementById('kembalian');
            
            document.getElementById('total_uang_masuk').textContent = formatRupiah(totalUangMasuk);

            if (totalUangMasuk > 0) {
                const kembalian = totalUangMasuk - totalBelanja;
                kembalianDisplay.textContent = formatRupiah(kembalian);
                
                if (kembalian < 0) {
                     kembalianDisplay.style.color = 'red';
                     document.getElementById('total_uang_masuk').style.color = 'red';
                } else {
                     kembalianDisplay.style.color = '#dc3545';
                     document.getElementById('total_uang_masuk').style.color = '#007bff';
                }
            } else {
                kembalianDisplay.textContent = formatRupiah(0);
                kembalianDisplay.style.color = '#dc3545'; 
            }
        }

        // 5. Fungsi Finalisasi Transaksi (Update Stok & Pendapatan)
        function hitungTotal() {
            const totalDisplay = document.getElementById('total-belanja').textContent;
            const totalBelanja = parseFloat(totalDisplay.replace(/[^0-9]/g, '')) || 0; 
            
            const uangCash = parseFloat(document.getElementById('uang_cash').value) || 0;
            const uangQris = parseFloat(document.getElementById('uang_qris').value) || 0;
            const totalUangMasuk = uangCash + uangQris;

            if (totalBelanja === 0) {
                alert("Keranjang belanja kosong!"); 
                return;
            }

            if (totalUangMasuk < totalBelanja) {
                alert(`Pembayaran kurang! Total yang harus dibayar: ${formatRupiah(totalBelanja)}.`); 
            } else {
                let revenueCash = uangCash;
                let revenueQris = uangQris;
                
                if (totalUangMasuk > totalBelanja) {
                    revenueCash = totalBelanja - uangQris;
                    if (revenueCash < 0) {
                         revenueCash = 0;
                         revenueQris = totalBelanja; 
                    }
                }

                // AKUMULASI PENDAPATAN & SIMPAN KE LOCALSTORAGE
                totalRevenueCash += revenueCash;
                totalRevenueQris += revenueQris;
                saveRevenueData();
                
                // Update Stok Terjual dan SIMPAN DATA PRODUK
                products.forEach(product => {
                    const quantity = currentOrderQuantities[product.id] || 0;
                    if (quantity > 0) {
                        // Kuantitas yang terjual sekarang berupa desimal
                        product.terjual += quantity; 
                    }
                });
                saveProductsToStorage();
                
                alert(`Transaksi Selesai! Pendapatan dicatat: Tunai ${formatRupiah(revenueCash)} + QRIS ${formatRupiah(revenueQris)}.`);

                // Reset Tampilan POS dan Laporan
                resetPOS();
                updateReport(); 
                updateRevenueReport(); 
            }
        }

        // 6. Fungsi updateRevenueReport (Laporan Pendapatan Persisten) - Tetap sama
        function updateRevenueReport() {
            const totalGrand = totalRevenueCash + totalRevenueQris;
            
            document.getElementById('rekap_cash').textContent = formatRupiah(totalRevenueCash);
            document.getElementById('rekap_qris').textContent = formatRupiah(totalRevenueQris);
            document.getElementById('rekap_grand_total').textContent = formatRupiah(totalGrand);
        }
        
        // 7. Fungsi endDayAndClearData (Z-Report Lengkap) - PERUBAHAN TAMPILAN DESIMAL
        function endDayAndClearData() {
            const confirmation = confirm("Apakah Anda yakin ingin MENGAKHIRI HARI KERJA? Laporan Z-Report akan dibuat, dan semua data (Stok & Pendapatan) hari ini akan direset.");
            
            if (confirmation) {
                // --- 1. KOMPILASI LAPORAN STOK AKHIR ---
                let stockReport = "LAPORAN SISA STOK HARI INI:\n";
                products.forEach(p => {
                    const sisa = (p.stokAwal - p.terjual).toFixed(1); // Tampilkan sisa dengan 1 desimal
                    stockReport += `- ${p.name}: Stok Awal ${p.stokAwal.toFixed(1)}, Terjual ${p.terjual.toFixed(1)}, Sisa ${sisa}\n`;
                });
                
                // --- 2. KOMPILASI LAPORAN PENDAPATAN ---
                const totalGrand = totalRevenueCash + totalRevenueQris;
                let revenueReport = `\nLAPORAN PENDAPATAN:\n`;
                revenueReport += `- Tunai: ${formatRupiah(totalRevenueCash)}\n`;
                revenueReport += `- Non-Tunai: ${formatRupiah(totalRevenueQris)}\n`;
                revenueReport += `TOTAL PENJUALAN: ${formatRupiah(totalGrand)}`;
                
                // Tampilkan laporan akhir yang lengkap
                alert(`----- Z-REPORT LENGKAP -----\n\n${stockReport}\n${revenueReport}\n\n------------------------------\nData hari ini akan direset.`);
                
                // --- 3. RESET DATA ---
                
                products = JSON.parse(JSON.stringify(initialProductsData));
                localStorage.removeItem('products_data');

                localStorage.removeItem('revenue_cash');
                localStorage.removeItem('revenue_qris');
                
                totalRevenueCash = 0;
                totalRevenueQris = 0;
                
                // Reset tampilan
                updateRevenueReport(); 
                loadDailyStockInputs();
                loadProductsTable(); 
                alert("Sistem telah direset. Siap untuk hari baru!");
            }
        }

        // 8. Fungsi mereset input dan tampilan (PERUBAHAN TAMPILAN DESIMAL)
        function resetPOS() {
            document.getElementById('uang_cash').value = 0;
            document.getElementById('uang_qris').value = 0;
            products.forEach(product => {
                const qtyInput = document.getElementById(`qty-${product.id}`);
                if (qtyInput) qtyInput.value = '0';
                
                const stokSisaEl = document.getElementById(`stok-sisa-${product.id}`);
                if (stokSisaEl) stokSisaEl.textContent = (product.stokAwal - product.terjual).toFixed(1);
                
                currentOrderQuantities[product.id] = 0;
            });
            updateSubtotal();
        }

        // 9. Fungsi menampilkan laporan stok (PERUBAHAN TAMPILAN DESIMAL)
        function updateReport() {
            const reportDiv = document.getElementById('report-info');
            reportDiv.innerHTML = '';
            
            products.forEach(product => {
                const stokSisa = product.stokAwal - product.terjual;
                const p = document.createElement('p');
                
                const colorClass = stokSisa <= 5 ? 'red-text' : 'green-text';

                p.innerHTML = `<strong>${product.name}:</strong> Stok Harian: ${product.stokAwal.toFixed(1)}, Terjual: <span class="green-text">${product.terjual.toFixed(1)}</span>, Sisa Stok: <span class="${colorClass}">${stokSisa.toFixed(1)}</span>`;
                reportDiv.appendChild(p);
            });
        }

        // Jalankan fungsi saat halaman selesai dimuat
        window.onload = function() {
            loadDailyStockInputs(); 
            loadProductsTable(); 
            updateSubtotal();
        };
    </script>

</body>
</html>