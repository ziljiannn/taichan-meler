<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS Taichan Setengah Porsi LENGKAP</title>
    
    <style>
        /* ====================
           CSS STYLES
           ==================== */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 20px; 
            background-color: #e9ecef; 
            display: flex; 
            justify-content: center; 
        }
        .pos-container { 
            width: 100%; 
            max-width: 950px; 
            background: white; 
            padding: 25px; 
            border-radius: 10px; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); 
        }
        h1 { 
            text-align: center; 
            color: #dc3545; 
            border-bottom: 2px solid #dc3545; 
            padding-bottom: 10px; 
            margin-bottom: 20px; 
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-bottom: 25px; 
            font-size: 0.95em;
        }
        th, td { 
            border: 1px solid #dee2e6; 
            padding: 10px; 
            text-align: left; 
        }
        th { 
            background-color: #dc3545; 
            color: white; 
            font-weight: 600; 
        }
        input[type="number"], .qty-input { 
            width: 60px; 
            padding: 8px; 
            border: 1px solid #ced4da; 
            border-radius: 4px; 
            text-align: center; 
        }
        .qty-input {
            width: 70px;
            font-weight: bold;
            color: #007bff; 
        }
        .total-section { 
            padding: 15px; 
            border-top: 3px double #343a40; 
            margin-top: 10px; 
            font-size: 1.2em; 
        }
        .total-row, .payment-row, .change-row { 
            display: flex; 
            justify-content: space-between; 
            padding: 5px 0; 
        }
        .label { 
            font-weight: bold; 
        }
        .value { 
            font-weight: normal; 
            color: #dc3545; 
        }
        .payment-input-group {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }
        .payment-input-group > div {
            display: flex;
            justify-content: space-between;
            width: 350px; 
        }
        .payment-input-group input[type="number"] {
            width: 150px; 
            padding: 10px; 
            font-size: 1.1em; 
            text-align: right; 
        }
        .payment-label {
            font-weight: normal;
        }
        button { 
            padding: 10px 20px; 
            background-color: #28a745; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 1em; 
            margin-top: 15px; 
        }
        button:hover { 
            background-color: #218838; 
        }
        .stock-info { 
            font-size: 0.9em; 
            margin-top: 30px; 
            padding: 15px; 
            border: 1px solid #dc3545; 
            border-radius: 5px;
            background-color: #ffe6e6; 
        }
        .stock-info h3 { 
            margin-top: 0; 
            color: #dc3545; 
            border-bottom: 1px dashed #dc3545;
            padding-bottom: 5px;
        }
        .red-text { color: red; font-weight: bold; }
        .green-text { color: green; font-weight: bold; }

        .revenue-report {
            background-color: #fff3cd; 
            border: 1px solid #ffc107;
            padding: 10px;
            margin-top: 15px;
            border-radius: 5px;
        }
        .revenue-report .rev-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            font-size: 1.1em;
        }
        .revenue-report .rev-row.grand-total {
            font-weight: bold;
            border-top: 1px dashed #ffc107;
            margin-top: 5px;
            padding-top: 5px;
        }
        #end-day-button {
            background-color: #dc3545;
            margin-left: 10px;
        }
        #end-day-button:hover {
            background-color: #c82333;
        }
        
        .daily-stock-input {
            width: 100%;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            background-color: #f8f9fa;
            flex-direction: column; 
        }
        .daily-stock-input-row {
             display: flex; 
             gap: 15px; 
             flex-wrap: wrap;
        }
        .daily-stock-input label {
            font-weight: bold;
            color: #343a40;
            margin-right: 5px;
        }
        .daily-stock-input input {
            width: 50px; 
            text-align: right;
        }
        
        /* Expense Section Styles (Dana Keluar) */
        .expense-section {
            padding: 15px;
            margin-top: 20px;
            border: 1px solid #6c757d;
            border-radius: 5px;
            background-color: #f0f8ff; 
        }
        .expense-section h3 {
            color: #6c757d;
            border-bottom: 1px dashed #6c757d;
            padding-bottom: 5px;
            margin-top: 0;
        }
        .expense-input-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .expense-input-group input[type="text"] {
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            width: 200px;
        }
        .expense-input-group input[type="number"] {
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            width: 120px;
            text-align: right;
        }
        #add-expense-button {
            background-color: #6c757d;
            margin-top: 0;
        }
        #add-expense-button:hover {
            background-color: #5a6268;
        }
        #expense-list {
            margin-top: 10px;
            font-size: 0.9em;
            color: #343a40;
            max-height: 100px;
            overflow-y: auto;
            border-top: 1px dashed #ced4da;
            padding-top: 5px;
        }
        .total-expense-row {
            font-size: 1.1em;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            padding-top: 5px;
            border-top: 2px solid #6c757d;
            color: #dc3545;
        }

        /* Queue Section Styles (Antrian) */
        .queue-section {
            margin-top: 25px;
            padding: 15px;
            border: 2px solid #007bff; 
            border-radius: 8px;
            background-color: #e6f7ff; 
        }
        .queue-section h3 {
            color: #007bff;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }
        .queue-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed #ccc;
        }
        .queue-item:last-child {
            border-bottom: none;
        }
        .queue-details {
            flex-grow: 1;
        }
        .queue-details strong {
            font-size: 1.1em;
            color: #343a40;
            display: block;
        }
        .queue-details span {
            font-size: 0.9em;
            color: #6c757d;
        }
        .queue-actions button {
            background-color: #ffc107; 
            color: black;
            padding: 8px 15px;
            margin-top: 0;
            white-space: nowrap;
        }
        .queue-actions button:hover {
            background-color: #e0a800;
        }
        #queue-list-container {
            min-height: 50px;
            padding-top: 5px;
        }
    </style>
</head>
<body>

    <div class="pos-container">
        <h1>üå∂Ô∏è POS Sate Taichan (Full Fitur)</h1>

        <div class="daily-stock-input">
            <span style="font-weight: bold; width: 100%; color: #dc3545;">Input Stok Harian (Unit Porsi):</span>
            <div id="daily-stock-container" class="daily-stock-input-row"></div>
            <button onclick="updateStokHarian()" style="background-color: #007bff; margin-top: 0;">Update Stok & Mulai Jual</button>
        </div>
        
        <h2>Daftar Produk</h2>
        <table>
            <thead>
                <tr>
                    <th>Nama Produk</th>
                    <th>Harga Porsi (Rp)</th>
                    <th>Harga Half (Rp)</th>
                    <th>Stok Tersedia (Unit)</th> 
                    <th>Jumlah Beli (Porsi/Desimal)</th>
                    <th>Subtotal (Rp)</th>
                </tr>
            </thead>
            <tbody id="items-list">
                </tbody>
        </table>
        
        <div class="total-section">
            <div class="total-row">
                <span class="label">TOTAL BELANJA:</span>
                <span id="total-belanja" class="value">Rp 0</span>
            </div>
            
            <div class="payment-row">
                <span class="label">METODE BAYAR:</span>
                <div class="payment-input-group">
                    <div>
                        <span class="payment-label">Cash (Tunai):</span>
                        <input type="number" id="uang_cash" min="0" value="0">
                    </div>
                    <div>
                        <span class="payment-label">QRIS / Non-Tunai:</span>
                        <input type="number" id="uang_qris" min="0" value="0">
                    </div>
                </div>
            </div>

            <div class="total-row">
                <span class="label" style="color: #007bff;">TOTAL UANG MASUK:</span>
                <span id="total_uang_masuk" class="value" style="color: #007bff;">Rp 0</span>
            </div>


            <button onclick="hitungTotal()">Finalisasi Transaksi & Masukkan ke Antrian</button>

            <hr style="margin-top: 20px; border-color: #ced4da;">

            <div class="change-row">
                <span class="label">KEMBALIAN:</span>
                <span id="kembalian" class="value">Rp 0</span>
            </div>
        </div>
        
        <div class="expense-section">
            <h3>üí∏ Dana Keluar Harian (Pengeluaran)</h3>
            <div class="expense-input-group">
                <input type="text" id="expense-description" placeholder="Deskripsi Pengeluaran (Contoh: Beli Es)" style="flex-grow: 1;">
                <input type="number" id="expense-amount" min="0" value="0" placeholder="Jumlah (Rp)">
                <button id="add-expense-button" onclick="addExpense()">Tambah Pengeluaran</button>
            </div>
            <div id="expense-list">
                </div>
            <div class="total-expense-row">
                <span>TOTAL PENGELUARAN:</span>
                <span id="total-expense-display">Rp 0</span>
            </div>
        </div>

        <div class="queue-section">
            <h3>üìã Antrian Pesanan (Belum Selesai)</h3>
            <div id="queue-list-container">
                <p style="text-align: center; color: #6c757d;" id="no-queue-message">Tidak ada pesanan dalam antrian.</p>
            </div>
        </div>

        <div class="stock-info">
            <h3>Laporan Penjualan & Stok Sisa</h3>
            <div id="report-info"></div>
        </div>

        <div class="revenue-report">
            <h3>Rekapitulasi Pendapatan Harian (Persisten)</h3>
            <div class="rev-row">
                <span>Total Penjualan Tunai:</span>
                <span id="rekap_cash">Rp 0</span>
            </div>
            <div class="rev-row">
                <span>Total Penjualan Non-Tunai (QRIS):</span>
                <span id="rekap_qris">Rp 0</span>
            </div>
             <div class="rev-row">
                <span>(-) Total Pengeluaran:</span>
                <span id="rekap_expense" class="red-text">Rp 0</span>
            </div>
            <div class="rev-row grand-total">
                <span>TOTAL AKUMULASI PENDAPATAN BERSIH:</span>
                <span id="rekap_grand_total">Rp 0</span>
            </div>
            <button id="end-day-button" onclick="endDayAndClearData()">Akhiri Hari & Reset Data (Z-Report)</button>
        </div>
    </div>

    <script>
        /* ====================
           JAVASCRIPT: LOGIKA POS LENGKAP
           ==================== */

        // ===================================
        // VARIABEL GLOBAL & PERSISTENSI
        // ===================================
        // Ambil data dari Local Storage atau set ke 0/nilai default
        let totalRevenueCash = parseFloat(localStorage.getItem('revenue_cash')) || 0;
        let totalRevenueQris = parseFloat(localStorage.getItem('revenue_qris')) || 0;
        let totalExpenses = parseFloat(localStorage.getItem('total_expenses')) || 0;
        let expensesList = JSON.parse(localStorage.getItem('expenses_list')) || [];
        let orderQueue = JSON.parse(localStorage.getItem('order_queue')) || [];
        let currentOrderQuantities = {};
        let orderCounter = parseInt(localStorage.getItem('order_counter')) || 1; 
        
        // Data Produk Awal sesuai gambar Anda
        const initialProductsData = [
            { id: 1, name: "Campur", price: 25000, priceHalf: 17000, stokAwal: 0, terjual: 0 },
            { id: 2, name: "Kulit", price: 25000, priceHalf: 17000, stokAwal: 0, terjual: 0 },
            { id: 3, name: "Daging", price: 25000, priceHalf: 17000, stokAwal: 0, terjual: 0 },
            { id: 4, name: "Lontong", price: 4000, priceHalf: 3000, stokAwal: 0, terjual: 0 }
        ];

        let products = loadProductsFromStorage() || JSON.parse(JSON.stringify(initialProductsData));

        function loadProductsFromStorage() {
            const storedProducts = localStorage.getItem('products_data');
            if (storedProducts) {
                // Periksa apakah produk di storage masih sesuai dengan template
                const stored = JSON.parse(storedProducts);
                if (stored.length === initialProductsData.length) {
                    return stored;
                }
            }
            return null; // Gunakan data awal jika tidak ada/tidak valid
        }

        function saveProductsToStorage() {
            localStorage.setItem('products_data', JSON.stringify(products));
        }


        const formatRupiah = (number) => {
            const num = parseFloat(number) || 0;
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(num);
        };

        function saveRevenueData() {
            localStorage.setItem('revenue_cash', totalRevenueCash);
            localStorage.setItem('revenue_qris', totalRevenueQris);
            localStorage.setItem('total_expenses', totalExpenses);
            localStorage.setItem('expenses_list', JSON.stringify(expensesList));
            localStorage.setItem('order_queue', JSON.stringify(orderQueue));
            localStorage.setItem('order_counter', orderCounter);
        }
        
        // --- 1. FUNGSI STOK HARIAN ---

        function loadDailyStockInputs() {
            const container = document.getElementById('daily-stock-container');
            container.innerHTML = '';
            
            products.forEach(product => {
                const div = document.createElement('div');
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.innerHTML = `
                    <label for="input-stok-${product.id}">${product.name}:</label>
                    <input type="number" id="input-stok-${product.id}" min="0" step="0.5" value="${product.stokAwal.toFixed(1)}">
                `;
                container.appendChild(div);
            });
        }
        
        function updateStokHarian() {
            let totalStokSet = 0;
            
            products.forEach(product => {
                const inputElement = document.getElementById(`input-stok-${product.id}`);
                const stokBaru = parseFloat(inputElement.value) || 0; 
                
                // Jika stok berubah, reset jumlah terjual untuk hari itu
                if (stokBaru !== product.stokAwal) {
                     product.terjual = 0; 
                }
                
                product.stokAwal = stokBaru;
                totalStokSet += stokBaru;
            });
            
            saveProductsToStorage();
            
            if (totalStokSet >= 0) {
                loadProductsTable(); 
                alert("Stok harian berhasil diperbarui. Siap berjualan!");
            } else {
                alert("Masukkan jumlah stok harian Anda!");
            }
        }
        
        // --- 2. FUNGSI PENJUALAN ---

        function loadProductsTable() {
            const tableBody = document.getElementById('items-list');
            tableBody.innerHTML = ''; 
            let hasStok = false;

            products.forEach(product => {
                const row = tableBody.insertRow();
                
                row.insertCell().textContent = product.name;
                row.insertCell().textContent = formatRupiah(product.price);
                row.insertCell().textContent = formatRupiah(product.priceHalf); 

                const stokSisa = product.stokAwal - product.terjual;
                if (stokSisa > 0) hasStok = true; 
                
                const stokCell = row.insertCell();
                stokCell.id = `stok-sisa-${product.id}`;
                stokCell.textContent = stokSisa.toFixed(1); 
                stokCell.style.fontWeight = 'bold'; 

                const quantityCell = row.insertCell();
                const quantityInput = document.createElement('input');
                quantityInput.type = 'text'; 
                quantityInput.className = 'qty-input'; 
                quantityInput.value = '0';
                quantityInput.id = `qty-${product.id}`; 
                quantityInput.setAttribute('inputmode', 'decimal'); // Memungkinkan input desimal di HP
                quantityInput.addEventListener('input', updateSubtotal); 
                quantityCell.appendChild(quantityInput);

                const subtotalCell = row.insertCell();
                subtotalCell.id = `sub-${product.id}`; 
                subtotalCell.textContent = formatRupiah(0);

                currentOrderQuantities[product.id] = 0;
            });
            
            if (!hasStok && products.every(p => p.stokAwal === 0)) {
                document.getElementById('items-list').innerHTML = '<tr><td colspan="6" style="text-align: center; color: red;"><b>TIDAK ADA STOK HARI INI. SILAKAN INPUT DI ATAS.</b></td></tr>';
            }
            
            document.getElementById('uang_cash').addEventListener('input', updateChange); 
            document.getElementById('uang_qris').addEventListener('input', updateChange); 
            
            updateReport();
            updateRevenueReport();
            renderExpensesList(); 
            renderOrderQueue(); 
        }

        function updateSubtotal() {
            let grandTotal = 0;

            products.forEach(product => {
                const quantityInput = document.getElementById(`qty-${product.id}`);
                const subtotalDisplay = document.getElementById(`sub-${product.id}`);
                
                let rawQuantity = quantityInput.value.replace(',', '.'); // Handle koma sebagai desimal
                const quantity = parseFloat(rawQuantity) || 0; 
                
                const stokTersedia = product.stokAwal - product.terjual;

                if (quantity > stokTersedia) {
                    alert(`Stok ${product.name} yang tersisa hanya ${stokTersedia.toFixed(1)} unit! Jumlah pembelian direset.`);
                    
                    const newQuantity = Math.floor(stokTersedia * 2) / 2; // Membulatkan ke 0.5 terdekat yang lebih rendah
                    quantityInput.value = newQuantity.toFixed(1); 
                    
                    currentOrderQuantities[product.id] = newQuantity;

                    const subtotal = calculatePrice(product, newQuantity);
                    subtotalDisplay.textContent = formatRupiah(subtotal);
                    grandTotal += subtotal;

                } else {
                    currentOrderQuantities[product.id] = quantity;
                    
                    const subtotal = calculatePrice(product, quantity);
                    subtotalDisplay.textContent = formatRupiah(subtotal);
                    grandTotal += subtotal;
                }
            });

            document.getElementById('total-belanja').textContent = formatRupiah(grandTotal);
            updateChange(); 
        }

        function calculatePrice(product, quantity) {
            if (quantity <= 0) return 0;

            const fullPorsi = Math.floor(quantity); 
            // Cek apakah ada sisa 0.5
            const halfPorsi = quantity % 1 === 0.5 ? 1 : 0; 

            let total = (fullPorsi * product.price);

            if (halfPorsi === 1) {
                total += product.priceHalf;
            }
            return total;
        }

        function updateChange() {
            const totalDisplay = document.getElementById('total-belanja').textContent;
            const totalBelanja = parseFloat(totalDisplay.replace(/[^0-9]/g, '')) || 0; 
            
            const uangCash = parseFloat(document.getElementById('uang_cash').value) || 0;
            const uangQris = parseFloat(document.getElementById('uang_qris').value) || 0;
            
            const totalUangMasuk = uangCash + uangQris;
            const kembalianDisplay = document.getElementById('kembalian');
            
            document.getElementById('total_uang_masuk').textContent = formatRupiah(totalUangMasuk);

            if (totalUangMasuk > 0) {
                const kembalian = totalUangMasuk - totalBelanja;
                
                if (totalUangMasuk < totalBelanja) { 
                     kembalianDisplay.textContent = formatRupiah(kembalian); 
                     kembalianDisplay.style.color = 'red';
                     document.getElementById('total_uang_masuk').style.color = 'red';
                } else {
                     kembalianDisplay.textContent = formatRupiah(kembalian);
                     kembalianDisplay.style.color = '#dc3545';
                     document.getElementById('total_uang_masuk').style.color = '#007bff';
                }
            } else {
                kembalianDisplay.textContent = formatRupiah(0);
                kembalianDisplay.style.color = '#dc3545'; 
                document.getElementById('total_uang_masuk').style.color = '#007bff';
            }
        }

        function hitungTotal() {
            const totalDisplay = document.getElementById('total-belanja').textContent;
            const totalBelanja = parseFloat(totalDisplay.replace(/[^0-9]/g, '')) || 0; 
            
            const uangCashInput = parseFloat(document.getElementById('uang_cash').value) || 0;
            const uangQrisInput = parseFloat(document.getElementById('uang_qris').value) || 0;
            const totalUangMasuk = uangCashInput + uangQrisInput;

            if (totalBelanja === 0) {
                alert("Keranjang belanja kosong!"); 
                return;
            }

            if (totalUangMasuk < totalBelanja) {
                alert(`Pembayaran kurang! Total yang harus dibayar: ${formatRupiah(totalBelanja)}.`); 
            } else {
                
                const kembalian = totalUangMasuk - totalBelanja;
                let revenueQris = Math.min(uangQrisInput, totalBelanja); 
                const sisaPembayaran = totalBelanja - revenueQris;
                let revenueCash = Math.min(uangCashInput, sisaPembayaran);
                
                if (revenueCash + revenueQris !== totalBelanja) {
                    revenueCash = totalBelanja - revenueQris;
                }
                
                // --- 1. CATAT PENDAPATAN & UPDATE STOK ---
                totalRevenueCash += revenueCash;
                totalRevenueQris += revenueQris;
                
                const itemsOrdered = [];
                products.forEach(product => {
                    const quantity = currentOrderQuantities[product.id] || 0;
                    if (quantity > 0) {
                        product.terjual += quantity; 
                        itemsOrdered.push(`${product.name} (${quantity.toFixed(1)})`);
                    }
                });
                
                saveProductsToStorage();

                // --- 2. MASUKKAN KE ANTRIAN (QUEUE) ---
                const newOrder = {
                    id: orderCounter++,
                    timestamp: new Date().toLocaleTimeString('id-ID'),
                    total: totalBelanja,
                    items: itemsOrdered,
                    revenueCash: revenueCash,
                    revenueQris: revenueQris
                };
                orderQueue.push(newOrder);
                saveRevenueData();
                
                alert(`Transaksi Selesai! Pesanan #${newOrder.id} masuk antrian.\nKembalian: ${formatRupiah(kembalian)}`);

                // --- 3. RESET TAMPILAN ---
                resetPOS();
                updateReport(); 
                updateRevenueReport(); 
                renderOrderQueue(); 
            }
        }

        // --- 3. FUNGSI ANTRIAN (QUEUE) ---

        function renderOrderQueue() {
            const container = document.getElementById('queue-list-container');
            container.innerHTML = '';
            
            if (orderQueue.length === 0) {
                 container.innerHTML = '<p style="text-align: center; color: #6c757d;" id="no-queue-message">Tidak ada pesanan dalam antrian.</p>';
                 return;
            }

            orderQueue.forEach(order => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'queue-item';
                itemDiv.id = `order-${order.id}`;

                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'queue-details';
                detailsDiv.innerHTML = `
                    <strong>Antrian #${order.id} (${formatRupiah(order.total)})</strong>
                    <span>${order.items.join(', ')}</span>
                `;
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'queue-actions';
                const completeButton = document.createElement('button');
                completeButton.textContent = 'Konfirmasi Selesai';
                completeButton.onclick = () => completeOrder(order.id);
                actionsDiv.appendChild(completeButton);

                itemDiv.appendChild(detailsDiv);
                itemDiv.appendChild(actionsDiv);
                container.appendChild(itemDiv);
            });
        }
        
        function completeOrder(orderId) {
            const index = orderQueue.findIndex(order => order.id === orderId);
            
            if (index > -1) {
                // Hapus pesanan dari antrian
                orderQueue.splice(index, 1);
                saveRevenueData();
                
                alert(`Pesanan #${orderId} telah dikonfirmasi selesai dan dikeluarkan dari antrian.`);
                
                renderOrderQueue(); 
            }
        }

        // --- 4. FUNGSI PENGELUARAN (DANA KELUAR) ---

        function addExpense() {
            const descriptionInput = document.getElementById('expense-description');
            const amountInput = document.getElementById('expense-amount');
            
            const description = descriptionInput.value.trim();
            const amount = parseFloat(amountInput.value) || 0;

            if (description === "" || amount <= 0) {
                alert("Mohon masukkan deskripsi dan jumlah pengeluaran yang valid.");
                return;
            }

            const newExpense = {
                description: description,
                amount: amount,
                timestamp: new Date().toLocaleTimeString('id-ID')
            };

            expensesList.push(newExpense);
            totalExpenses += amount;

            saveRevenueData();
            
            renderExpensesList();
            updateRevenueReport();

            descriptionInput.value = '';
            amountInput.value = '0';
        }
        
        function renderExpensesList() {
            const listDiv = document.getElementById('expense-list');
            listDiv.innerHTML = '';
            
            expensesList.forEach((expense, index) => {
                const p = document.createElement('p');
                p.innerHTML = `(${expense.timestamp}) <b>${expense.description}</b>: <span class="red-text">${formatRupiah(expense.amount)}</span>`;
                listDiv.appendChild(p);
            });

            document.getElementById('total-expense-display').textContent = formatRupiah(totalExpenses);
        }
        
        // --- 5. FUNGSI PELAPORAN ---

        function updateRevenueReport() {
            const totalGross = totalRevenueCash + totalRevenueQris;
            const totalNet = totalGross - totalExpenses; 
            
            document.getElementById('rekap_cash').textContent = formatRupiah(totalRevenueCash);
            document.getElementById('rekap_qris').textContent = formatRupiah(totalRevenueQris);
            document.getElementById('rekap_expense').textContent = formatRupiah(totalExpenses);
            document.getElementById('rekap_grand_total').textContent = formatRupiah(totalNet);
        }
        
        function updateReport() {
            const reportDiv = document.getElementById('report-info');
            reportDiv.innerHTML = '';
            
            products.forEach(product => {
                const stokSisa = product.stokAwal - product.terjual;
                const p = document.createElement('p');
                
                const colorClass = stokSisa <= 5 ? 'red-text' : 'green-text';

                p.innerHTML = `<strong>${product.name}:</strong> Stok Harian: ${product.stokAwal.toFixed(1)}, Terjual: <span class="green-text">${product.terjual.toFixed(1)}</span>, Sisa Stok: <span class="${colorClass}">${stokSisa.toFixed(1)}</span>`;
                reportDiv.appendChild(p);
            });
        }
        
        function endDayAndClearData() {
            if (orderQueue.length > 0) {
                const queueConfirm = confirm(`PERINGATAN: Masih ada ${orderQueue.length} pesanan di antrian. Mohon selesaikan pesanan tersebut sebelum mengakhiri hari.\nApakah Anda yakin ingin tetap melanjutkan reset (pesanan di antrian akan HILANG)?`);
                if (!queueConfirm) {
                    return; 
                }
            }

            const confirmation = confirm("Apakah Anda yakin ingin MENGAKHIRI HARI KERJA? Laporan Z-Report akan dibuat, dan semua data (Stok, Pendapatan, Pengeluaran & Antrian) akan direset.");
            
            if (confirmation) {
                // --- KOMPILASI LAPORAN ---
                let stockReport = "LAPORAN SISA STOK HARI INI:\n";
                products.forEach(p => {
                    const sisa = (p.stokAwal - p.terjual).toFixed(1); 
                    stockReport += `- ${p.name}:
